# LEGO-LOAM-BOR拆解
✦ 现在我来详细解释点云投影模块(imageProjection)的实现原理：

  点云投影模块是LEGO-LOAM-BOR的第一步处理模块，其主要功能是将3D激光雷达点云数据转换为2D范围图像（range
  image），并进行地面点分割和聚类标记。具体实现原理如下：

   1. 点云预处理：
      - 接收原始点云数据，移除NAN值点
      - 如果设置了点云拼接(stitcher)，会将多个连续帧的点云合并以增加覆盖范围

   2. 倾斜激光雷达校正：
      - 对于安装有俯仰角的倾斜激光雷达，将其点云数据变换回水平状态
      - 使用传感器安装角度信息进行坐标变换

   3. 范围图像投影：
      - 将3D点云投影到2D极坐标系中，形成范围图像
      - 根据垂直和水平扫描线数，计算每个点在2D网格中的行列索引
      - 计算垂直角度：verticalAngle = asin(z / range)
      - 计算水平角度：horizonAngle = atan2(y, x)
      - 将3D点映射到2D网格：rowIdn = (verticalAngle + _ang_bottom) / _ang_resolution_Y
      - colIdn = -round((horizonAngle) / _ang_resolution_X) + _horizontal_scans * 0.5

   4. 地面点移除：
      - 通过检查相邻垂直扫描线上的点之间的垂直角度差来判断是否为地面点
      - 如果垂直角度差小于阈值（默认10度），则标记为地面点
      - 生成地面点云和非地面点云

   5. 点云分割：
      - 使用区域生长算法对非地面点进行聚类分割
      - 根据距离变化率判断点是否属于同一平面
      - 通过连通性分析将点分配到不同标签

   6. 输出结果：
      - 输出分割后的点云信息，包括地面点、分割后的点云、点云标签等
      - 通过Channel机制将结果传递给下一个模块

  这个模块的核心作用是将无序的3D点云转换为结构化的2D表示，便于后续的特征提取和匹配。

 ╭───────────────────────────────────────────────────────────╮

✦ 现在我来详细解释特征关联模块(featureAssociation)的实现原理：

  特征关联模块是LEGO-LOAM-BOR的第二步处理模块，其主要功能是在点云投影模块输出的基础上，提取边缘特征点和平面特征点，并通过迭代最近点(ICP)
  算法估计激光雷达的运动位姿。具体实现原理如下：

   1. 接收输入数据：
      - 从点云投影模块通过Channel接收分割后的点云数据
      - 包括分割的点云、地面点云、点云标签等信息

   2. 畸变校正：
      - 对于旋转式激光雷达，由于扫描过程中机器人可能移动，需要对点云进行运动畸变校正
      - 将点云中每个点的时间戳归一化到扫描开始或结束时刻

   3. 特征提取：
      - 计算每个点的曲率(smoothness)，用于区分边缘和平面特征
      - 曲率计算公式：cloudCurvature[i] = diffRange * diffRange
      - 其中diffRange是该点与其前后各5个点的距离变化之和
      - 标记被遮挡的点，避免使用不稳定的特征点

   4. 特征分类：
      - 在每个垂直扫描线上，根据曲率大小排序
      - 选取曲率最大的前几个点作为边缘特征点(corner points)
      - 选取曲率最小的前几个点作为平面特征点(surface points)
      - 边缘特征对应物体边界，平面特征对应平坦表面

   5. 特征匹配：
      - 使用KD树搜索当前帧特征点在上一帧点云中的最近邻点
      - 对于边缘特征，寻找最近邻点和次近邻点，构成直线段
      - 对于平面特征，寻找三个最近邻点，构成平面片

   6. 位姿估计：
      - 使用高斯-牛顿优化方法求解刚体变换矩阵
      - 构建误差函数：边缘点到直线的距离、平面点到平面的距离
      - 迭代优化6自由度位姿参数(rx, ry, rz, tx, ty, tz)
      - 分别对平面特征和边缘特征进行多次迭代优化

   7. 位姿积分：
      - 将当前帧相对于上一帧的位姿增量累积到全局位姿中
      - 更新激光雷达的轨迹

   8. 输出结果：
      - 发布提取的特征点云（边缘点、平面点）
      - 发布局部位姿估计结果
      - 将处理后的特征点云传递给地图优化模块

  这个模块的核心作用是通过特征匹配实现激光雷达里程计，提供相对精确的位姿估计。

 ╭───────────────────────────────────────────────────────────╮

✦ 现在我来详细解释地图优化模块(mapOptimization)的实现原理：

  地图优化模块是LEGO-LOAM-BOR的第三步处理模块，也是最核心的部分，它负责构建全局地图、执行闭环检测和图优化。具体实现原理如下：

   1. 接收输入数据：
      - 从特征关联模块通过Channel接收处理后的特征点云和位姿信息
      - 包括边缘特征点云、平面特征点云、离群点云等

   2. 位姿图构建：
      - 将当前帧的位姿作为节点添加到位姿图中
      - 使用iSAM2（增量平滑和映射）算法维护位姿图
      - 添加先验因子（第一帧）或位姿间约束因子（后续帧）

   3. 局部地图构建：
      - 提取当前位置周围的键帧构建局部地图
      - 使用KD树加速最近邻搜索
      - 对周围的关键帧进行降采样以提高效率

   4. Scan-to-Map配准：
      - 将当前帧的特征点与局部地图中的特征点进行匹配
      - 构建误差函数（边缘点到线段距离、平面点到平面距离）
      - 使用高斯-牛顿法优化当前位姿

   5. 闭环检测：
      - 搜索历史关键帧中与当前帧相近的位置
      - 使用ICP（迭代最近点）算法验证候选闭环
      - 如果找到可靠闭环，则添加闭环约束到图中

   6. 图优化：
      - 使用GTSAM库执行图优化
      - 同时优化所有位姿节点，减少累积误差
      - 通过iSAM2实现实时增量优化

   7. 地图发布：
      - 根据优化后的位姿更新关键帧
      - 发布全局地图点云
      - 发布局部地图和优化轨迹

   8. 关键帧管理：
      - 判断是否保存当前帧为关键帧
      - 只有当位置变化超过一定阈值时才保存
      - 维护关键帧队列以支持局部地图构建

  这个模块的核心作用是通过图优化技术消除里程计漂移，构建一致性的全局地图，并通过闭环检测进一步提高地图精度。

 ╭───────────────────────────────────────────────────────────╮

✦ 现在让我梳理三个模块之间的数据流和依赖关系：

  这三个模块构成了LEGO-LOAM-BOR的主要处理流水线，它们之间存在明确的数据流和依赖关系：

   1. 点云投影模块(imageProjection)：
      - 输入：原始激光雷达点云数据(sensor_msgs::PointCloud2)
      - 输出：分割后的点云、地面点云、点云标签信息等
      - 通过Channel<ProjectionOut>将结果传递给特征关联模块
      - 这是整个系统的入口模块，负责将3D点云转换为结构化数据

   2. 特征关联模块(featureAssociation)：
      - 输入：来自点云投影模块的分割结果
      - 处理：提取边缘和平面特征，执行ICP位姿估计
      - 输出：特征点云(边缘、平面)、位姿估计结果
      - 通过Channel<AssociationOut>将结果传递给地图优化模块
      - 依赖于点云投影模块的输出，是位姿估计的核心模块

   3. 地图优化模块(mapOptimization)：
      - 输入：来自特征关联模块的特征点云和位姿信息
      - 处理：构建位姿图、执行图优化、闭环检测
      - 输出：全局一致性地图、优化后的轨迹
      - 是整个系统的最终处理模块，负责全局一致性

  数据流关系：
   - imageProjection → featureAssociation → mapOptimization
   - 数据通过自定义的Channel机制在模块间传递
   - 每个模块都依赖前一个模块的输出结果

  时间同步关系：
   - 所有模块运行在独立的线程中
   - 通过Channel实现线程安全的数据传递
   - 确保数据按时间顺序正确处理

  反馈关系：
   - 地图优化模块会将优化后的位姿反馈给特征关联模块
   - 形成闭环优化，提高定位精度





 ╭───────────────────────────────────────────────────────────╮
# TODO
- [ ] 加外部LIO里程计并大改 Mapping 和 Localization。Lego-loam 对非结构式激光点云还是太不鲁棒了，跑自采 mid360 数据位姿估计太差。加 imu 的 lio 不容易丢，单独运行良好，但用作此工程作为其 wheel_odometry 反而频繁漂。考虑将整个建图定位栈全部替换为 fastlio 系，通过解构导航栈来迁移替换。lego-loam 对地面的提取和障碍物的分割有可取之处，所以只用其生成对接3D导航栈的 ground 和 map。
- [ ] 选型移植 fastlio 的回环和重定位模块
- [ ] 

# Implementation

- 不用此算法的定位功能，而在外部提供精确里程计定位，此算法系统能否坍缩成一个仅建图的单节点，关注于地图可行走地面点graph和静态3d障碍物的维护和低频发布，以及代表实时避障点云的发布。

- 还需要lego_loam的mapping是因为准备直接套用这套3d导航框架，其perception和planner都强依赖于原工程的点云处理结果。

